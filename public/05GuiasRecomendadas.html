<!DOCTYPE html>
<html lang="es">

  <head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Selección de Guías por Grado</title>
    <link href="style.css" rel="stylesheet"/>
    <style>
      .grados-container {
        margin-top: 1.5rem;
      }

      .grado-section {
        background: #f8f9fa;
        border-left: 4px solid #0C67B3;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 8px;
      }

      .grado-title {
        font-size: 1.2rem;
        color: #0C67B3;
        margin-bottom: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .grado-title .badge {
        background: #0C67B3;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.85rem;
      }

      .selector-row {
        margin-bottom: 1rem;
      }

      .selector-row label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }

      .selector-row select {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
        transition: border-color 0.2s;
      }

      .selector-row select:focus {
        outline: none;
        border-color: #0C67B3;
      }

      .selector-row select:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
      }

      .guias-radio-list {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0.5rem;
        margin-top: 0.5rem;
      }

      .guia-radio-item {
        display: flex;
        align-items: flex-start;
        gap: 0.8rem;
        padding: 0.8rem 1rem;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
        cursor: pointer;
      }

      .guia-radio-item:last-child {
        border-bottom: none;
      }

      .guia-radio-item:hover {
        background: #f5f5f5;
      }

      .guia-radio-item input[type="radio"] {
        width: 18px;
        height: 18px;
        margin-top: 2px;
        cursor: pointer;
        accent-color: #0C67B3;
      }

      .guia-info {
        flex: 1;
      }

      .guia-numero {
        background: #0C67B3;
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 0.5rem;
      }

      .guia-titulo {
        font-weight: 500;
        color: #333;
      }

      .guia-concepto {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.3rem;
        font-style: italic;
      }

      .area-header {
        background: linear-gradient(135deg, #0C67B3 0%, #0a5490 100%);
        color: white;
        padding: 1.2rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
      }

      .area-header h2 {
        margin: 0;
        font-size: 1.4rem;
      }

      .area-header p {
        margin: 0.3rem 0 0 0;
        opacity: 0.9;
        font-size: 0.95rem;
      }

      .no-data-message {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 1rem;
        border-radius: 6px;
        color: #856404;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      .seleccion-status {
        background: #e8f5e9;
        border: 1px solid #4caf50;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #2e7d32;
      }

      .seleccion-status.pending {
        background: #fff3e0;
        border-color: #ff9800;
        color: #e65100;
      }

      .seleccion-status.complete {
        background: #e8f5e9;
        border-color: #4caf50;
        color: #2e7d32;
      }

      .guias-container {
        display: none;
      }

      .guias-container.visible {
        display: block;
      }
    </style>
  </head>

  <body>

    <header class="main-header">
      <div class="header-left">
        <img alt="Logo Escuela Nueva" class="logo" src="Images/logo.png"/>
        <h1 class="header-title">Asistente de Planeación Escuela Nueva Activa</h1>
      </div>
      <div class="header-right">
        <div class="line-with-hexagon">
          <svg fill="#fff" height="18" viewbox="0 0 17 18" width="17" xmlns="http://www.w3.org/2000/svg">
            <path d="M5.5481 1.74664C5.66453 1.58825 5.85386 1.50841 6.03582 1.54099L12.2487 2.65368C12.4132 2.68319 12.5472 2.79993 12.6032 2.96312L14.9298 9.74299C14.9857 9.90615 14.9557 10.0921 14.8505 10.2353L10.8754 15.6439C10.759 15.8022 10.5696 15.882 10.3877 15.8495L4.17478 14.7368C4.01029 14.7074 3.87643 14.5905 3.82036 14.4274L1.49375 7.64751C1.43774 7.48427 1.46774 7.29845 1.57304 7.15519L5.5481 1.74664Z" stroke="#0C67B3" stroke-width="3"></path>
          </svg>
          <svg fill="none" height="3" viewbox="0 0 554 3" width="554" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 1.5H553.457" stroke="#0C67B3" stroke-width="3"></path>
          </svg>
        </div>
      </div>
    </header>

    <content>
      <div class="form-wrapper">
        <form class="form-card">
          <div class="progress-module">
            <div class="hex-steps">
              <div class="hex inactive"><svg viewbox="0 0 100 100"><path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"></path></svg></div>
              <div class="hex inactive"><svg viewbox="0 0 100 100"><path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"></path></svg></div>
              <div class="hex inactive"><svg viewbox="0 0 100 100"><path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"></path></svg></div>
              <div class="hex inactive"><svg viewbox="0 0 100 100"><path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"></path></svg></div>
              <div class="hex active">
                <svg viewbox="0 0 100 100"> <path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"></path> </svg>
              </div>
              <div class="hex inactive"><svg viewbox="0 0 100 100"><path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"></path></svg></div>
              <div class="hex inactive"><svg viewbox="0 0 100 100"><path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"></path></svg></div>
            </div>
            <div class="progress-text">5 de 7</div>
          </div>

          <div class="modulo-hex-info">
            <div class="hex-badge-img" data-step="5" role="img" aria-label="Paso 5"></div>
            <div class="info-texto">
              <h3 class="info-titulo">Selección de Unidad y Guía por Grado</h3>
              <p class="info-subtitulo">Para cada grado, selecciona una unidad y luego una guía ENA</p>
            </div>
          </div>

          <hr/>

          <div id="contenido-guias">
            <div class="loading">
              <p>Cargando datos...</p>
            </div>
          </div>

          <div class="form-buttons">
            <button type="button" id="atras" class="btn-secondary">Atrás</button>
            <button type="submit" id="continuar" class="btn-primary">Continuar</button>
          </div>
        </form>
      </div>
    </content>

    <script src="main.js"></script>
    <script>
      // Estado global para esta página
      let seleccionesPorGrado = {};
      let unidadesPorGrado = {};

      // Cargar datos y construir la interfaz
      async function inicializar() {
        const step2Data = window.getStepData(2); // Grados
        const step4Data = window.getStepData(4); // Área y edición

        if (!step2Data || !step4Data) {
          document.getElementById('contenido-guias').innerHTML = `
            <div class="no-data-message">
              <strong>Información incompleta</strong>
              <p>Por favor completa los pasos anteriores (grados y área)</p>
            </div>
          `;
          return;
        }

        const grados = step2Data.grados || [];
        const area = step4Data.area;
        const areaNombre = step4Data.area_nombre;
        const edicion = step4Data.edicion_guia;

        if (grados.length === 0) {
          document.getElementById('contenido-guias').innerHTML = `
            <div class="no-data-message">
              <strong>No hay grados seleccionados</strong>
              <p>Regresa al paso 2 y selecciona los grados con los que trabajas</p>
            </div>
          `;
          return;
        }

        // Construir HTML
        let html = `
          <div class="area-header">
            <h2>${areaNombre}</h2>
            <p>Edición de guías: ${edicion}</p>
          </div>
          <div class="grados-container">
        `;

        // Crear sección para cada grado
        for (const grado of grados) {
          const gradoNum = grado.toString().replace(/\D/g, '') || grado;
          html += `
            <div class="grado-section" data-grado="${gradoNum}">
              <div class="grado-title">
                <span class="badge">Grado ${gradoNum}°</span>
                Selecciona unidad y guía
              </div>

              <div class="selector-row">
                <label for="unidad-${gradoNum}">1. Selecciona la Unidad:</label>
                <select id="unidad-${gradoNum}" data-grado="${gradoNum}" onchange="cargarGuiasDeUnidad('${gradoNum}', this.value)">
                  <option value="">-- Cargando unidades... --</option>
                </select>
              </div>

              <div class="selector-row guias-container" id="guias-container-${gradoNum}">
                <label>2. Selecciona la Guía:</label>
                <div class="guias-radio-list" id="guias-list-${gradoNum}">
                  <p style="padding: 1rem; color: #666;">Primero selecciona una unidad</p>
                </div>
              </div>

              <div class="seleccion-status pending" id="status-${gradoNum}">
                Pendiente: Selecciona unidad y guía
              </div>
            </div>
          `;

          // Inicializar selecciones para este grado
          seleccionesPorGrado[gradoNum] = null;
          unidadesPorGrado[gradoNum] = [];
        }

        html += '</div>';
        document.getElementById('contenido-guias').innerHTML = html;

        // Cargar unidades para cada grado
        for (const grado of grados) {
          const gradoNum = grado.toString().replace(/\D/g, '') || grado;
          await cargarUnidadesGrado(area, gradoNum);
        }
      }

      // Cargar unidades disponibles para un grado
      async function cargarUnidadesGrado(area, grado) {
        const selectUnidad = document.getElementById(`unidad-${grado}`);

        try {
          const response = await fetch(`/api/guias-data/temas-por-grado/${area}/${grado}`);
          const result = await response.json();

          if (result.success && result.data.temas && result.data.temas.length > 0) {
            unidadesPorGrado[grado] = result.data.temas;

            let options = '<option value="">-- Selecciona una unidad --</option>';
            result.data.temas.forEach(tema => {
              options += `<option value="${tema.id}">Unidad ${tema.id}: ${tema.titulo}</option>`;
            });
            selectUnidad.innerHTML = options;
          } else {
            selectUnidad.innerHTML = '<option value="">No hay unidades disponibles</option>';
          }
        } catch (error) {
          console.error(`Error al cargar unidades para grado ${grado}:`, error);
          selectUnidad.innerHTML = '<option value="">Error al cargar unidades</option>';
        }
      }

      // Cargar guías de una unidad específica para un grado
      async function cargarGuiasDeUnidad(grado, unidadId) {
        const guiasContainer = document.getElementById(`guias-container-${grado}`);
        const guiasList = document.getElementById(`guias-list-${grado}`);

        if (!unidadId) {
          guiasContainer.classList.remove('visible');
          guiasList.innerHTML = '<p style="padding: 1rem; color: #666;">Primero selecciona una unidad</p>';
          seleccionesPorGrado[grado] = null;
          actualizarStatus(grado);
          return;
        }

        guiasList.innerHTML = '<p style="padding: 1rem; color: #666;">Cargando guías...</p>';
        guiasContainer.classList.add('visible');

        const step4Data = window.getStepData(4);
        const area = step4Data.area;

        try {
          const response = await fetch(`/api/guias-data/guias/${area}/${grado}/${unidadId}`);
          const result = await response.json();

          if (result.success && result.data.guias && result.data.guias.length > 0) {
            const unidadInfo = result.data.unidad;
            let html = '';

            result.data.guias.forEach(guia => {
              const radioId = `guia-${grado}-${guia.numero}`;
              html += `
                <label class="guia-radio-item" for="${radioId}">
                  <input type="radio"
                         id="${radioId}"
                         name="guia-grado-${grado}"
                         data-grado="${grado}"
                         data-unidad="${unidadId}"
                         data-unidad-titulo="${unidadInfo.titulo}"
                         data-numero="${guia.numero}"
                         data-titulo="${guia.titulo}"
                         onchange="seleccionarGuia('${grado}', this)">
                  <div class="guia-info">
                    <span class="guia-numero">${guia.numero}</span>
                    <span class="guia-titulo">${guia.titulo}</span>
                    ${guia.concepto ? `<div class="guia-concepto">${guia.concepto}</div>` : ''}
                  </div>
                </label>
              `;
            });

            guiasList.innerHTML = html;
          } else {
            guiasList.innerHTML = '<p style="padding: 1rem; color: #666;">No hay guías disponibles para esta unidad</p>';
          }
        } catch (error) {
          console.error(`Error al cargar guías:`, error);
          guiasList.innerHTML = '<p style="padding: 1rem; color: #c00;">Error al cargar las guías</p>';
        }

        // Limpiar selección previa
        seleccionesPorGrado[grado] = null;
        actualizarStatus(grado);
      }

      // Seleccionar una guía
      function seleccionarGuia(grado, radio) {
        seleccionesPorGrado[grado] = {
          unidad: parseInt(radio.dataset.unidad),
          unidad_titulo: radio.dataset.unidadTitulo,
          numero: parseInt(radio.dataset.numero),
          titulo: radio.dataset.titulo,
          nombre: radio.dataset.titulo
        };
        actualizarStatus(grado);
      }

      // Actualizar estado visual
      function actualizarStatus(grado) {
        const statusEl = document.getElementById(`status-${grado}`);
        const seleccion = seleccionesPorGrado[grado];

        if (seleccion) {
          statusEl.className = 'seleccion-status complete';
          statusEl.textContent = `✓ Seleccionado: Unidad ${seleccion.unidad} - Guía ${seleccion.numero}: ${seleccion.titulo}`;
        } else {
          statusEl.className = 'seleccion-status pending';
          statusEl.textContent = 'Pendiente: Selecciona unidad y guía';
        }
      }

      // Event listeners
      document.getElementById('atras').addEventListener('click', function() {
        window.location.href = '04GuiasENAAreas.html';
      });

      document.getElementById('continuar').addEventListener('click', function(e) {
        e.preventDefault();

        const step2Data = window.getStepData(2);
        const grados = step2Data?.grados || [];

        // Validar que todos los grados tengan una guía seleccionada
        let todosSeleccionados = true;
        let gradosSinSeleccion = [];

        grados.forEach(grado => {
          const gradoNum = grado.toString().replace(/\D/g, '') || grado;
          if (!seleccionesPorGrado[gradoNum]) {
            todosSeleccionados = false;
            gradosSinSeleccion.push(gradoNum);
          }
        });

        if (!todosSeleccionados) {
          alert(`Por favor selecciona una unidad y guía para: Grado ${gradosSinSeleccion.join('°, Grado ')}°`);
          return;
        }

        // Guardar datos del paso 5
        const step4Data = window.getStepData(4);

        // Transformar selecciones al formato esperado por el backend
        const guiasRecomendadas = {};
        Object.entries(seleccionesPorGrado).forEach(([grado, guia]) => {
          if (guia) {
            guiasRecomendadas[`grado_${grado}`] = [{
              unidad: guia.unidad,
              guia: guia.numero,
              nombre: guia.titulo
            }];
          }
        });

        window.saveStepData(5, {
          area: step4Data.area,
          area_nombre: step4Data.area_nombre,
          edicion_guia: step4Data.edicion_guia,
          selecciones_por_grado: seleccionesPorGrado,
          guias_recomendadas: guiasRecomendadas
        });

        window.location.href = '06InformacionDocente.html';
      });

      // Inicializar al cargar
      window.addEventListener('DOMContentLoaded', inicializar);
    </script>
  </body>
</html>
