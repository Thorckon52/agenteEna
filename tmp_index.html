
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agente ENA - Plan Flexible</title>
  <style>
    :root {
      --c1: #0057a3;
      --c2: #ee7f00;
      --c3: #e2001a;
      --c4: #ffcc00;
      --c5: #87888a;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Calibri, Arial, sans-serif;
      margin: 20px;
      background: #fff;
      color: #222;
    }
    h1 {
      color: var(--c1);
      margin: 0 0 16px;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 840px;
      border: 1px solid #e3e5e7;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      display: grid;
      gap: 18px;
    }
    fieldset {
      border: 1px solid #d5d8dc;
      border-radius: 8px;
      padding: 16px;
      margin: 0;
    }
    legend {
      padding: 0 6px;
      font-weight: 600;
      color: var(--c1);
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      color: #1f2933;
    }
    input[type="text"],
    input[type="number"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #cfd3d7;
      font-family: Calibri, Arial, sans-serif;
      font-size: 15px;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--c1);
      border-color: var(--c1);
    }
    button {
      padding: 10px 16px;
      background: var(--c1);
      color: #fff;
      border: 0;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: #024b8c; }
    .radio-group,
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .radio-group label,
    .checkbox-group label {
      font-weight: 500;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .card-list {
      margin-top: 12px;
      display: grid;
      gap: 12px;
    }
    .card {
      border: 1px solid #d8dadd;
      border-radius: 8px;
      padding: 12px;
      background: #f9fafb;
    }
    .card h4 {
      margin: 0 0 8px;
      font-size: 16px;
      color: var(--c1);
    }
    .dificultad-detalle {
      margin-top: 12px;
      display: grid;
      gap: 12px;
    }
    .dif-row {
      border: 1px solid #d8dadd;
      border-radius: 8px;
      padding: 12px;
      background: #f9fafb;
    }
    .dif-row h5 {
      margin: 0 0 8px;
      font-size: 15px;
      color: #111827;
    }
    .dif-options {
      display: grid;
      gap: 6px;
      margin-top: 8px;
    }
    .note {
      font-size: 13px;
      color: #4b5563;
      margin-top: 6px;
    }
    .warning {
      color: var(--c3);
      font-weight: 600;
    }
    .hidden { display: none !important; }
    pre {
      background: #f7fbff;
      color: #222;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      overflow-x: auto;
      border-left: 4px solid var(--c1);
      border: 1px solid #e3e5e7;
      max-width: 840px;
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #cbd5e1;
      border-top-color: var(--c1);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: text-bottom;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .section {
      margin: 24px 0;
      padding: 16px;
      border: 1px solid #e3e5e7;
      border-radius: 8px;
      background: #fdfdfd;
    }
    .section h2 {
      margin-top: 0;
    }
    .meta {
      margin-bottom: 12px;
      color: var(--c5);
      font-size: 14px;
    }
    .grade-block {
      margin-bottom: 16px;
      padding: 12px;
      border: 1px solid #dfe3e6;
      border-radius: 8px;
      background: #f7f8fa;
    }
    .grade-block h3 {
      margin: 0 0 10px;
      color: var(--c1);
    }
    .nested {
      margin-left: 16px;
      padding-left: 12px;
      border-left: 2px solid #e3e5e7;
    }
    .kv {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
    }
    .kv th,
    .kv td {
      border: 1px solid #d8dadd;
      padding: 6px 8px;
      text-align: left;
    }
    .muted {
      color: var(--c5);
    }
    #vista {
      max-width: 840px;
    }
  </style>
</head>
<body>
  <h1>Generar Plan Docente Flexible</h1>
  <form id="planForm" onsubmit="return false;">
    <fieldset>
      <legend>1. Datos generales del aula</legend>
      <label for="institucion">Institucion</label>
      <input type="text" id="institucion" required placeholder="Nombre de la institucion" />

      <label for="departamento">Departamento</label>
      <select id="departamento" required>
        <option value="">Selecciona un departamento</option>
      </select>

      <label for="municipio">Municipio</label>
      <select id="municipio" required disabled>
        <option value="">Selecciona un municipio</option>
      </select>

      <label for="zona">Zona</label>
      <select id="zona" required>
        <option value="Rural">Rural</option>
        <option value="Urbana">Urbana</option>
      </select>

      <label for="tipo_aula">Tipo de aula</label>
      <select id="tipo_aula" required>
        <option value="monogrado">Monogrado</option>
        <option value="multigrado">Multigrado</option>
      </select>
    </fieldset>

    <fieldset>
      <legend>2. Grados y estudiantes</legend>
      <label for="grados">Grados (separados por coma)</label>
      <input type="text" id="grados" placeholder="Ej: 1,2,3" />
      <p class="note">Usa solo la etiqueta del grado. Ejemplo: 1, 2, 3 o Transicion</p>
      <div id="conteoContainer" class="card-list"></div>
    </fieldset>

    <fieldset>
      <legend>3. Dificultades de lectura</legend>
      <div class="radio-group">
        <label><input type="radio" name="lectura_hay" value="no" checked /> No</label>
        <label><input type="radio" name="lectura_hay" value="si" /> Si</label>
      </div>
      <div id="lecturaDetalle" class="dificultad-detalle hidden"></div>
    </fieldset>

    <fieldset>
      <legend>4. Dificultades de escritura</legend>
      <div class="radio-group">
        <label><input type="radio" name="escritura_hay" value="no" checked /> No</label>
        <label><input type="radio" name="escritura_hay" value="si" /> Si</label>
      </div>
      <div id="escrituraDetalle" class="dificultad-detalle hidden"></div>
    </fieldset>

    <fieldset>
      <legend>5. Dificultades de comprension</legend>
      <div class="radio-group">
        <label><input type="radio" name="comprension_hay" value="no" checked /> No</label>
        <label><input type="radio" name="comprension_hay" value="si" /> Si</label>
      </div>
      <div id="comprensionDetalle" class="dificultad-detalle hidden"></div>
    </fieldset>

    <fieldset>
      <legend>6. Organizacion del salon</legend>
      <div class="radio-group">
        <label><input type="radio" name="organizacion" value="filas" checked /> Filas</label>
        <label><input type="radio" name="organizacion" value="u" /> En U</label>
        <label><input type="radio" name="organizacion" value="parejas" /> En parejas</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>7. Recursos disponibles</legend>
      <div class="checkbox-group">
        <label><input type="checkbox" name="recurso" value="Mesitas para trabajo en grupo" /> Mesitas para trabajo en grupo</label>
        <label><input type="checkbox" name="recurso" value="Rincon de matematicas" /> Rincon de matematicas</label>
        <label><input type="checkbox" name="recurso" value="Rincon de sociales" /> Rincon de sociales</label>
        <label><input type="checkbox" name="recurso" value="Rincon de naturales" /> Rincon de naturales</label>
        <label><input type="checkbox" name="recurso" value="Rincon de lenguaje" /> Rincon de lenguaje</label>
        <label><input type="checkbox" name="recurso" value="Biblioteca aula" /> Biblioteca aula</label>
        <label><input type="checkbox" name="recurso" value="TV" /> TV</label>
        <label><input type="checkbox" name="recurso" value="Computador" /> Computador</label>
        <label><input type="checkbox" name="recurso" value="Grabadora" /> Grabadora</label>
        <label><input type="checkbox" name="recurso" value="Internet" /> Internet</label>
      </div>
      <label for="recurso_otro">Otro recurso (opcional)</label>
      <input type="text" id="recurso_otro" placeholder="Escribe otro recurso" />

      <label for="frecuencia_recursos">Frecuencia de uso</label>
      <select id="frecuencia_recursos">
        <option value="sin_definir">Selecciona una opcion</option>
        <option value="todos_los_dias">Todos los dias</option>
        <option value="tres_cuatro_dias">Entre 3 y 4 dias a la semana</option>
        <option value="uno_dos_dias">Entre 1 y 2 dias a la semana</option>
        <option value="no_uso">No las uso</option>
      </select>
      <p id="enaRecordatorio" class="note warning hidden">Recuerda que las Guias ENA son un elemento fundamental del componente curricular.</p>
    </fieldset>

    <fieldset>
      <legend>8. Gobierno estudiantil y comites</legend>
      <label>Tienen gobierno estudiantil?</label>
      <div class="radio-group">
        <label><input type="radio" name="gobierno" value="si" /> Si</label>
        <label><input type="radio" name="gobierno" value="no" checked /> No</label>
      </div>

      <label>Tienen comites funcionando?</label>
      <div class="radio-group">
        <label><input type="radio" name="comites" value="si" /> Si</label>
        <label><input type="radio" name="comites" value="no" checked /> No</label>
      </div>
      <div id="comitesLista" class="checkbox-group hidden">
        <label><input type="checkbox" name="comite_opcion" value="Convivencia" /> Convivencia</label>
        <label><input type="checkbox" name="comite_opcion" value="Aseo o Medio ambiente" /> Aseo o Medio ambiente</label>
        <label><input type="checkbox" name="comite_opcion" value="Deportes o Recreacion" /> Deportes o Recreacion</label>
      </div>
      <label for="comite_otro" class="hidden" id="comiteOtroLabel">Otro comite (opcional)</label>
      <input type="text" id="comite_otro" class="hidden" placeholder="Escribe otro comite" />
    </fieldset>

    <fieldset>
      <legend>9. Instrumentos que usan en clase</legend>
      <div class="checkbox-group">
        <label><input type="checkbox" name="instrumento" value="Autocontrol de asistencia" /> Autocontrol de asistencia</label>
        <label><input type="checkbox" name="instrumento" value="Correo de la amistad" /> Correo de la amistad</label>
        <label><input type="checkbox" name="instrumento" value="Buzon de sugerencias" /> Buzon de sugerencias</label>
        <label><input type="checkbox" name="instrumento" value="Buzon de compromisos" /> Buzon de compromisos</label>
        <label><input type="checkbox" name="instrumento" value="Cuadro de valores" /> Cuadro de valores</label>
      </div>
      <label for="instrumento_otro">Otro instrumento (opcional)</label>
      <input type="text" id="instrumento_otro" placeholder="Escribe otro instrumento" />
    </fieldset>

    <fieldset>
      <legend>10. Alineacion curricular</legend>
      <label for="area">Area principal</label>
      <select id="area" required>
        <option value="Matematica">Matematica</option>
        <option value="Sociales">Sociales</option>
        <option value="Naturales">Naturales</option>
        <option value="Lenguaje">Lenguaje</option>
        <option value="Tecnologia">Tecnologia</option>
        <option value="Etica">Etica</option>
      </select>
    </fieldset>

    <button type="button" id="generarBtn">Generar plan</button>
  </form>

  <h2>Resultado</h2>
  <pre id="resultado">Esperando datos...</pre>

  <section id="vista" style="display:none; margin-top:16px;">
    <div class="controls" style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
      <textarea id="ajuste" placeholder="Deseas hacer una modificacion? (una sola vez)"
        style="flex:1; min-height:48px; padding:8px 10px; border:1px solid #cfd3d7; border-radius:6px; font-family: Calibri, Arial, sans-serif;"></textarea>
      <button id="aplicar" style="background: var(--c2);">Aplicar modificacion</button>
      <button id="omitir" class="secondary">Omitir</button>
      <button id="descargar" disabled>Descargar PDF</button>
    </div>
    <div id="guia" class="guide" style="background:#fff; padding:16px; border:1px solid #e3e5e7; border-radius:8px;"></div>
  </section>
  <script>
    (function () {
      const formEl = document.getElementById("planForm");
      const gradosEl = document.getElementById("grados");
      const conteoContainer = document.getElementById("conteoContainer");
      const lecturaDetalle = document.getElementById("lecturaDetalle");
      const escrituraDetalle = document.getElementById("escrituraDetalle");
      const comprensionDetalle = document.getElementById("comprensionDetalle");
      const generarBtn = document.getElementById("generarBtn");
      const resultadoEl = document.getElementById("resultado");
      const frecuenciaSelect = document.getElementById("frecuencia_recursos");
      const recordatorioENA = document.getElementById("enaRecordatorio");
      const comitesLista = document.getElementById("comitesLista");
      const comiteOtroLabel = document.getElementById("comiteOtroLabel");
      const comiteOtroInput = document.getElementById("comite_otro");
      const areaEl = document.getElementById("area");
      const departamentoEl = document.getElementById("departamento");
      const municipioEl = document.getElementById("municipio");
      let lastResult = null;

      const dificultadesConfig = {
        lectura: [
          "Lee muy lentamente o silabea en exceso",
          "Confunde letras (ej. j con g, b con d, c con k)",
          "Omite, repite o inventa palabras",
          "Pierde la secuencia y vuelve al inicio",
          "Necesita apoyo visual para seguir la lectura",
          "Presenta baja comprension de lo leido",
          "Evita leer en voz alta"
        ],
        escritura: [
          "Letra poco legible o tamano irregular",
          "Desorganizacion en el uso del espacio",
          "Errores frecuentes en letras o palabras",
          "Uso incorrecto de mayusculas y signos",
          "Dificultad para ordenar ideas",
          "Escritura muy lenta o muy rapida con errores",
          "Evita escribir o muestra frustracion"
        ],
        comprension: [
          "Lectura mecanica sin entendimiento",
          "Dificultad para identificar la idea principal",
          "Problemas de vocabulario",
          "Falta de secuenciacion",
          "Baja capacidad de inferencia",
          "Dificultad para relacionar con experiencias previas",
          "Problemas de atencion y concentracion"
        ]
      };

      const state = {
        grados: [],
        estudiantes: {},
        dificultades: {
          lectura: { hay: false, por_grado: {} },
          escritura: { hay: false, por_grado: {} },
          comprension: { hay: false, por_grado: {} }
        }
      };

      function uniq(list) {
        const seen = new Set();
        const result = [];
        list.forEach((item) => {
          const key = item.trim();
          if (!key) return;
          const norm = key.replace(/\s+/g, " ");
          if (!seen.has(norm)) {
            seen.add(norm);
            result.push(norm);
          }
        });
        return result;
      }

      function syncGradosFromInput() {
        const raw = (gradosEl.value || "").split(",");
        const clean = uniq(raw);
        state.grados = clean;
        const keep = new Set(clean);
        Object.keys(state.estudiantes).forEach((grado) => {
          if (!keep.has(grado)) delete state.estudiantes[grado];
        });
        ["lectura", "escritura", "comprension"].forEach((tipo) => {
          const por = state.dificultades[tipo].por_grado;
          Object.keys(por).forEach((grado) => {
            if (!keep.has(grado)) delete por[grado];
          });
        });
        renderConteo();
        renderDificultad("lectura", lecturaDetalle);
        renderDificultad("escritura", escrituraDetalle);
        renderDificultad("comprension", comprensionDetalle);
      }

      function renderConteo() {
        conteoContainer.innerHTML = "";
        if (!state.grados.length) return;
        state.grados.forEach((grado) => {
          const card = document.createElement("div");
          card.className = "card";
          const title = document.createElement("h4");
          title.textContent = "Grado " + grado;
          const label = document.createElement("label");
          label.textContent = "Numero de estudiantes";
          const input = document.createElement("input");
          input.type = "number";
          input.min = "1";
          input.placeholder = "Cantidad";
          input.value = state.estudiantes[grado] ?? "";
          input.dataset.grado = grado;
          input.addEventListener("input", () => {
            const value = parseInt(input.value, 10);
            if (Number.isFinite(value) && value > 0) {
              state.estudiantes[grado] = value;
            } else {
              delete state.estudiantes[grado];
            }
          });
          card.appendChild(title);
          card.appendChild(label);
          card.appendChild(input);
          conteoContainer.appendChild(card);
        });
      }

      function buildDifRow(tipo, grado) {
        const row = document.createElement("div");
        row.className = "dif-row";
        const title = document.createElement("h5");
        title.textContent = "Grado " + grado;
        const label = document.createElement("label");
        label.textContent = "Estudiantes con dificultad";
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.placeholder = "Cantidad";
        const current = state.dificultades[tipo].por_grado[grado];
        input.value = current ? current.cantidad : "";
        input.addEventListener("input", () => {
          const value = parseInt(input.value, 10);
          const entry = state.dificultades[tipo].por_grado[grado] || { cantidad: 0, dificultades: [] };
          if (Number.isFinite(value) && value >= 0) {
            entry.cantidad = value;
            state.dificultades[tipo].por_grado[grado] = entry;
          } else {
            entry.cantidad = 0;
            state.dificultades[tipo].por_grado[grado] = entry;
          }
        });

        const optionsWrap = document.createElement("div");
        optionsWrap.className = "dif-options";
        (dificultadesConfig[tipo] || []).forEach((texto) => {
          const optionLabel = document.createElement("label");
          optionLabel.style.display = "flex";
          optionLabel.style.alignItems = "center";
          optionLabel.style.gap = "6px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = texto;
          const entry = state.dificultades[tipo].por_grado[grado];
          if (entry && Array.isArray(entry.dificultades) && entry.dificultades.includes(texto)) {
            checkbox.checked = true;
          }
          checkbox.addEventListener("change", () => {
            const currentEntry = state.dificultades[tipo].por_grado[grado] || { cantidad: 0, dificultades: [] };
            if (!Array.isArray(currentEntry.dificultades)) {
              currentEntry.dificultades = [];
            }
            if (checkbox.checked) {
              if (!currentEntry.dificultades.includes(texto)) {
                currentEntry.dificultades.push(texto);
              }
            } else {
              currentEntry.dificultades = currentEntry.dificultades.filter((item) => item !== texto);
            }
            state.dificultades[tipo].por_grado[grado] = currentEntry;
          });
          optionLabel.appendChild(checkbox);
          optionLabel.appendChild(document.createTextNode(texto));
          optionsWrap.appendChild(optionLabel);
        });

        row.appendChild(title);
        row.appendChild(label);
        row.appendChild(input);
        row.appendChild(optionsWrap);
        return row;
      }

      function renderDificultad(tipo, container) {
        container.innerHTML = "";
        if (!state.dificultades[tipo].hay) {
          container.classList.add("hidden");
          return;
        }
        container.classList.remove("hidden");
        state.grados.forEach((grado) => {
          if (!state.dificultades[tipo].por_grado[grado]) {
            state.dificultades[tipo].por_grado[grado] = { cantidad: 0, dificultades: [] };
          }
          container.appendChild(buildDifRow(tipo, grado));
        });
      }

      function toggleRecordatorio() {
        if (frecuenciaSelect.value === "no_uso") {
          recordatorioENA.classList.remove("hidden");
        } else {
          recordatorioENA.classList.add("hidden");
        }
      }

      frecuenciaSelect.addEventListener("change", toggleRecordatorio);

      gradosEl.addEventListener("input", syncGradosFromInput);

      [
        { tipo: "lectura", radios: document.querySelectorAll('input[name="lectura_hay"]'), contenedor: lecturaDetalle },
        { tipo: "escritura", radios: document.querySelectorAll('input[name="escritura_hay"]'), contenedor: escrituraDetalle },
        { tipo: "comprension", radios: document.querySelectorAll('input[name="comprension_hay"]'), contenedor: comprensionDetalle },
      ].forEach(({ tipo, radios, contenedor }) => {
        radios.forEach((radio) => {
          radio.addEventListener("change", () => {
            state.dificultades[tipo].hay = radio.value === "si";
            if (!state.dificultades[tipo].hay) {
              state.dificultades[tipo].por_grado = {};
            }
            renderDificultad(tipo, contenedor);
          });
        });
      });

      document.querySelectorAll('input[name="comites"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          if (radio.value === "si") {
            comitesLista.classList.remove("hidden");
            comiteOtroLabel.classList.remove("hidden");
            comiteOtroInput.classList.remove("hidden");
          } else {
            comitesLista.classList.add("hidden");
            comiteOtroLabel.classList.add("hidden");
            comiteOtroInput.classList.add("hidden");
            document.querySelectorAll('input[name="comite_opcion"]').forEach((chk) => { chk.checked = false; });
            comiteOtroInput.value = "";
          }
        });
      });

      function collectChecked(name) {
        return Array.from(document.querySelectorAll('input[name="' + name + '"]:checked')).map((el) => el.value);
      }

      function buildDificultadPayload(tipo) {
        const base = state.dificultades[tipo];
        const payload = { hay: base.hay, por_grado: {} };
        if (!base.hay) {
          return payload;
        }
        state.grados.forEach((grado) => {
          const entry = base.por_grado[grado] || { cantidad: 0, dificultades: [] };
          const cantidad = Number.isFinite(entry.cantidad) ? entry.cantidad : 0;
          const dificultades = Array.isArray(entry.dificultades) ? entry.dificultades : [];
          payload.por_grado[grado] = { cantidad, dificultades };
        });
        return payload;
      }
      generarBtn.addEventListener("click", async () => {
        const institucion = document.getElementById("institucion").value.trim();
        const municipio = document.getElementById("municipio").value.trim();
        const zona = document.getElementById("zona").value;
        const tipoAula = document.getElementById("tipo_aula").value;
        const organizacion = (document.querySelector('input[name="organizacion"]:checked') || { value: "filas" }).value;
        const grados = state.grados;

        if (!institucion || !document.getElementById("departamento").value.trim() || !municipio) {
          resultadoEl.textContent = "? Error: completa institucion, departamento y municipio.";
          return;
        }
        if (!grados.length) {
          resultadoEl.textContent = "? Error: agrega al menos un grado.";
          return;
        }
        const conteo = {};
        let valido = true;
        grados.forEach((grado) => {
          const total = state.estudiantes[grado];
          if (!Number.isFinite(total) || total < 1) {
            valido = false;
          } else {
            conteo[grado] = total;
          }
        });
        if (!valido || Object.keys(conteo).length !== grados.length) {
          resultadoEl.textContent = "? Error: ingresa la cantidad de estudiantes (>=1) para cada grado.";
          return;
        }

        const recursos = collectChecked("recurso");
        const recursoOtro = document.getElementById("recurso_otro").value.trim();
        if (recursoOtro) recursos.push(recursoOtro);

        const frecuenciaUso = frecuenciaSelect.value || "sin_definir";
        const gobierno = (document.querySelector('input[name="gobierno"]:checked') || { value: "no" }).value === "si";
        const comitesActivos = (document.querySelector('input[name="comites"]:checked') || { value: "no" }).value === "si";
        const listaComites = comitesActivos ? collectChecked("comite_opcion") : [];
        if (comitesActivos) {
          const otro = comiteOtroInput.value.trim();
          if (otro) listaComites.push(otro);
        }

        const instrumentos = collectChecked("instrumento");
        const instrumentoOtro = document.getElementById("instrumento_otro").value.trim();
        if (instrumentoOtro) instrumentos.push(instrumentoOtro);

        const contexto = {
          institucion,
          departamento: document.getElementById("departamento").value,
          municipio,
          zona,
          tipo_aula: tipoAula,
          grados,
          duracion_clase_min: 60,
          estudiantes_por_grado: conteo,
          recursos_aula: recursos,
          dificultades_lectura: buildDificultadPayload("lectura"),
          dificultades_escritura: buildDificultadPayload("escritura"),
          dificultades_comprension: buildDificultadPayload("comprension"),
          organizacion_salon: organizacion,
          frecuencia_uso_recursos: frecuenciaUso || "sin_definir",
          gobierno_estudiantil_activo: gobierno,
          comites_funcionando: {
            hay: comitesActivos,
            lista: listaComites
          },
          instrumentos_aula: instrumentos
        };

        const data = {
          contexto,
          alineacion_curricular: {
            area: areaEl.value,
            temas_prioritarios: ["Tema"],
            desempenos_esperados: ["Desempeno"],
            ras_dba_referencia: []
          },
          planificacion: {
            modalidad: "flexible",
            duracion_total_plan_min: 180
          },
          metadatos: {
            version_schema: "1.0.0",
            fecha_generacion: new Date().toISOString().split("T")[0],
            autor: "Docente"
          },
          por_grados: [],
          adaptaciones: {
            ritmos_aprendizaje: [],
            estrategias_multigrado: [],
            apoyos_pares: [],
            materiales_alternativos: []
          },
          articulaciones_ENA: {
            gobierno_estudiantil: [],
            comites_y_roles: [],
            convivencia_y_rutinas: [],
            familia_comunidad: []
          },
          seguimiento: {
            indicadores: ["participacion"],
            frecuencia: "semanal",
            instrumentos: ["lista de cotejo"]
          },
          observaciones_docente: []
        };

        resultadoEl.innerHTML = '<span class="spinner" aria-hidden="true"></span> Generando guia...';
        generarBtn.disabled = true;
        try {
          const res = await fetch('/api/generate-flex', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(data)
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error('HTTP ' + res.status + ' ' + res.statusText + ': ' + text);
          }
          const result = await res.json();
          lastResult = result;
          resultadoEl.textContent = JSON.stringify(result, null, 2);
          showInlineGuide(result, data);
        } catch (err) {
          console.error(err);
          resultadoEl.textContent = 'Error al generar la guia: ' + err.message;
        } finally {
          generarBtn.disabled = false;
        }
      });

      function EH(str) {
        if (typeof str !== 'string') return '';
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
      function L(arr) {
        if (!Array.isArray(arr) || !arr.length) return '<p class="muted">-</p>';
        return '<ul>' + arr.map((item) => '<li>' + EH(String(item)) + '</li>').join('') + '</ul>';
      }
      function TR(o) {
        if (!o) return '';
        return Object.entries(o)
          .map(([k, v]) => '<tr><td>' + EH(k) + '</td><td>' + EH(String(v)) + '</td></tr>')
          .join('');
      }
      function PG(por) {
        if (!Array.isArray(por) || !por.length) return '<p class="muted">-</p>';
        return por
          .map((g, idx) => {
            if (!g || typeof g !== 'object') {
              const fallback = g == null ? '-' : g;
              return '<div class="grade-block"><h3>Grado ' + (idx + 1) + '</h3><p>' + EH(String(fallback)) + '</p></div>';
            }
            const heading = EH(g.grado ? String(g.grado) : 'Grado ' + (idx + 1));
            const body = Object.entries(g)
              .filter(([key]) => key !== 'grado')
              .map(([key, value]) => {
                if (Array.isArray(value)) {
                  if (value.every((item) => typeof item === 'string')) {
                    return '<div><strong>' + EH(key) + ':</strong> ' + L(value) + '</div>';
                  }
                  return (
                    '<div><strong>' + EH(key) + ':</strong>' +
                    value
                      .map((item, j) => {
                        if (item && typeof item === 'object') {
                          const rows = Object.entries(item).map(([subKey, subValue]) => subKey + ': ' + (subValue == null ? '-' : subValue));
                          return '<div class="nested"><em>Item ' + (j + 1) + '</em>' + L(rows) + '</div>';
                        }
                        const fallbackItem = item == null ? '-' : item;
                        return '<div class="nested"><em>Item ' + (j + 1) + '</em>' + EH(String(fallbackItem)) + '</div>';
                      })
                      .join('') +
                    '</div>'
                  );
                }
                if (value && typeof value === 'object') {
                  return '<div><strong>' + EH(key) + ':</strong><table class="kv"><tbody>' + TR(value) + '</tbody></table></div>';
                }
                const fallbackValue = value == null ? '-' : value;
                return '<div><strong>' + EH(key) + ':</strong> ' + EH(String(fallbackValue)) + '</div>';
              })
              .join('');
            return '<div class="grade-block"><h3>' + heading + '</h3>' + body + '</div>';
          })
          .join('');
      }
      function RG(p) {
        const md = p?.metadatos || {};
        const ctx = p?.contexto || {};
        const ali = p?.alineacion_curricular || {};
        const pla = p?.planificacion || {};
        const por = Array.isArray(p?.por_grados) ? p.por_grados : [];
        const ada = p?.adaptaciones || {};
        const art = p?.articulaciones_ENA || {};
        const seg = p?.seguimiento || {};
        const obs = Array.isArray(p?.observaciones_docente) ? p.observaciones_docente : [];

        const est =
          ctx.estudiantes_por_grado && typeof ctx.estudiantes_por_grado === 'object'
            ? '<table class="kv"><thead><tr><th>Grado</th><th>Estudiantes</th></tr></thead><tbody>' +
              Object.entries(ctx.estudiantes_por_grado)
                .map(([g, c]) => '<tr><td>' + EH(g) + '</td><td>' + EH(String(c)) + '</td></tr>')
                .join('') +
              '</tbody></table>'
            : '<p class="muted">-</p>';

        return (
          '<h1>Plan Docente Flexible</h1>' +
          '<div class="meta">Autor: ' + EH(md.autor || '-') + ' \u0007 Fecha: ' + EH(md.fecha_generacion || '-') + ' \u0007 Version: ' + EH(md.version_schema || '-') + '</div>' +
          '<div class="section"><h2>Contexto</h2><div class="grid"><div><strong>Institucion:</strong> ' + EH(ctx.institucion || '-') +
          '</div><div><strong>Municipio:</strong> ' + EH(ctx.municipio || '-') + '</div><div><strong>Zona:</strong> ' + EH(ctx.zona || '-') +
          '</div><div><strong>Tipo de aula:</strong> ' + EH(ctx.tipo_aula || '-') + '</div><div><strong>Grados:</strong> ' +
          (Array.isArray(ctx.grados) ? EH(ctx.grados.join(', ')) : '-') + '</div><div><strong>Duracion clase (min):</strong> ' +
          EH(String(ctx.duracion_clase_min ?? '-')) + '</div></div><h3>Recursos del aula</h3>' +
          (Array.isArray(ctx.recursos_aula) && ctx.recursos_aula.length ? L(ctx.recursos_aula) : '<p class="muted">-</p>') +
          '<h3>Estudiantes por grado</h3>' + est + '</div>' +
          '<div class="section"><h2>Alineacion Curricular</h2><div><strong>Area:</strong> ' + EH(ali.area || '-') + '</div><h3>Temas prioritarios</h3>' +
          L(ali.temas_prioritarios) + '<h3>Desempenos esperados</h3>' + L(ali.desempenos_esperados) + '</div>' +
          '<div class="section"><h2>Planificacion</h2><div class="grid"><div><strong>Modalidad:</strong> ' + EH(pla.modalidad || '-') +
          '</div><div><strong>Duracion total (min):</strong> ' + EH(String(pla.duracion_total_plan_min ?? '-')) + '</div></div></div>' +
          '<div class="section"><h2>Trabajo por Grados</h2>' + PG(por) + '</div>' +
          '<div class="section"><h2>Adaptaciones</h2><h3>Ritmos de aprendizaje</h3>' + L(ada.ritmos_aprendizaje) +
          '<h3>Estrategias multigrado</h3>' + L(ada.estrategias_multigrado) + '<h3>Apoyos entre pares</h3>' + L(ada.apoyos_pares) +
          '<h3>Materiales alternativos</h3>' + L(ada.materiales_alternativos) + '</div>' +
          '<div class="section"><h2>Articulaciones ENA</h2><h3>Gobierno estudiantil</h3>' + L(art.gobierno_estudiantil) +
          '<h3>Comites y roles</h3>' + L(art.comites_y_roles) + '<h3>Convivencia y rutinas</h3>' + L(art.convivencia_y_rutinas) +
          '<h3>Familia y comunidad</h3>' + L(art.familia_comunidad) + '</div>' +
          '<div class="section"><h2>Seguimiento</h2><div><strong>Frecuencia:</strong> ' + EH(seg.frecuencia || '-') + '</div><h3>Indicadores</h3>' +
          L(seg.indicadores) + '<h3>Instrumentos</h3>' + L(seg.instrumentos) + '</div>' +
          '<div class="section"><h2>Observaciones del Docente</h2>' + L(obs) + '</div>'
        );
      }

      function showInlineGuide(plan, original) {
        const vista = document.getElementById('vista');
        const guia = document.getElementById('guia');
        const aplicar = document.getElementById('aplicar');
        const omitir = document.getElementById('omitir');
        const descargar = document.getElementById('descargar');
        const ajuste = document.getElementById('ajuste');
        let usado = false;
        vista.style.display = '';
        guia.innerHTML = RG(plan);
        aplicar.onclick = async () => {
          if (usado) return;
          usado = true;
          aplicar.disabled = true;
          ajuste.disabled = true;
          try {
            const res = await fetch('/api/generate-flex', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({ ...original, ajuste_docente: ajuste.value.trim() })
            });
            if (!res.ok) {
              const t = await res.text();
              throw new Error(t);
            }
            const nuevo = await res.json();
            guia.innerHTML = RG(nuevo);
            descargar.disabled = false;
          } catch (e) {
            alert('Error al aplicar modificacion: ' + e.message);
            descargar.disabled = false;
          }
        };
        omitir.onclick = () => {
          usado = true;
          aplicar.disabled = true;
          ajuste.disabled = true;
          descargar.disabled = false;
        };
        descargar.onclick = () => {
          window.print();
        };
      }

      (function initDepartamentosMunicipios() {
        if (!departamentoEl || !municipioEl) return;
        const RAW_URL = 'https://raw.githubusercontent.com/JairPrada/api-places-colombia/main/data/departamentos.js';
        const LOCAL_URL = 'departamentos.json';
        const FALLBACK = [
          { nombre: 'Amazonas', municipios: ['Leticia', 'Puerto Narino'] },
          { nombre: 'Antioquia', municipios: ['Medellin', 'Bello', 'Envigado', 'Itagui'] },
          { nombre: 'Cundinamarca', municipios: ['Bogota D.C.', 'Soacha', 'Zipaquira'] },
          { nombre: 'Valle del Cauca', municipios: ['Cali', 'Palmira', 'Buga', 'Tulua'] }
        ];

        function setOptions(sel, values, placeholder) {
          sel.innerHTML = '';
          const opt0 = document.createElement('option');
          opt0.value = '';
          opt0.textContent = placeholder;
          sel.appendChild(opt0);
          values.forEach((v) => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });
        }

        let loaded = false;
        function populate(catalog) {
          loaded = true;
          const nombres = catalog
            .map((d) => d.nombre || d.departamento || d.name)
            .filter(Boolean)
            .sort((a, b) => a.localeCompare(b));
          setOptions(departamentoEl, nombres, 'Selecciona un departamento');
          municipioEl.disabled = true;
          departamentoEl.addEventListener('change', () => {
            const nom = departamentoEl.value;
            const entry = catalog.find((d) => (d.nombre || d.departamento || d.name) === nom);
            const municipios = entry ? entry.municipios || entry.ciudades || entry.municipalities || [] : [];
            setOptions(municipioEl, municipios, 'Selecciona un municipio');
            municipioEl.disabled = municipios.length === 0;
          });
        }

        async function loadLocalThenRemote() {
          try {
            const local = await fetch(LOCAL_URL);
            if (local.ok) {
              const catalog = await local.json();
              populate(catalog);
            }
          } catch {}
          if (!loaded) {
            await load();
          }
        }

        async function load() {
          try {
            const res = await fetch(RAW_URL);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const js = await res.text();
            const start = js.indexOf('[');
            const end = js.lastIndexOf(']');
            if (start === -1 || end === -1) throw new Error('Formato no reconocido');
            let slice = js.slice(start, end + 1);
            slice = slice.replace(/(\w+)\s*:/g, '"$1":');
            slice = slice.replace(/'([^']*)'/g, (m, p1) => '"' + p1.replace(/\\/g, '\\\\').replace(/\"/g, '\\"') + '"');
            slice = slice.replace(/,\s*([}\]])/g, '$1');
            const parsed = JSON.parse(slice);
            const catalog = parsed
              .map((d) => ({
                nombre: d.nombre || d.departamento || d.name,
                municipios: d.municipios || d.ciudades || d.municipalities || []
              }))
              .filter((d) => d.nombre);
            if (!catalog.length) throw new Error('Catalogo vacio');
            populate(catalog);
          } catch (e) {
            console.warn('No se pudo cargar el dataset remoto. Usando fallback.', e);
            populate(FALLBACK);
          }
        }
        loadLocalThenRemote();
      })();
    })();
  </script>
</body>
</html>
